name: UpdateDashboard

on:
  push:
  #workflow_dispatch:
  #schedule:
  #  - cron: '*/15 * * * *'  # Runs every 15 minutes


jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub

      - name: Update dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<EOF
          import os
          import json
          from github import Github
          from datetime import datetime

          # Initialize GitHub client
          g = Github(os.environ['GITHUB_TOKEN'])

          # Read the previous runs
          with open("logs/base_text_logs.txt", "r") as file:
              previous_runs = file.read()

          new_run_file = "log_" + datetime.now().strftime('%Y_%m_%d') + ".md"
          previous_runs += f"\n[{new_run_file}]({new_run_file})"

          new_run_file_text = f"| Owner | Repository | Workflow | Status | Last Run | URL |\n"
          new_run_file_text += f"| ----- | ---------- | -------- | ------ | -------- | --- |\n"

          # Update the previous.md file
          repo = g.get_repo("jburel/ome-resources-monitor")
          contents = repo.get_contents("logs/previous.md")
          repo.update_file(contents.path, "Add new entries", previous_runs, contents.sha)

          # Prepare the dashboard content
          with open("base_text.txt", "r") as file:
              dashboard = file.read()

          # Read the repositories
          with open("repositories.json", 'r') as file:
            data = json.load(file)
          entries = data["@graph"]
          run_text = ""
          for entry in entries:
              repo = g.get_repo(entry["repository"])
              workflows = repo.get_workflows()
              values = []
              # Check if the "workflows" entry is set
              value = entry.get("workflows")
              if value is not None:
                  dirty_values = value.split(",")
                  values = [item.lstrip() for item in dirty_values]

              set_branch = repo.default_branch
              for workflow in workflows:

                  # restrict to the specified workflows if set
                  if len(values) != 0 and workflow.name not in values:
                      continue
                  runs = workflow.get_runs(status='completed', branch=set_branch)
                  if runs.totalCount > 0:
                      latest_run = runs[0]
                      status = latest_run.conclusion.lower()
                      
                      # Create status badge
                      if status == 'success':
                          badge = f"![Success](https://img.shields.io/badge/Success-brightgreen)"
                      elif status == 'failure':
                          badge = f"![Failure](https://img.shields.io/badge/Failure-red)"
                      else:
                          badge = f"![{status.capitalize()}](https://img.shields.io/badge/{status.capitalize()}-yellow)"
                      
                      # Format last run date
                      last_run = latest_run.created_at.strftime("%Y-%m-%d %H:%M:%S")
                      run_text += f"| {repo.owner.login} | [{repo.name}]({repo.html_url}) | {workflow.name} | {badge} | {last_run} | [{latest_run.id}]({latest_run.html_url}) |\n"
          
          dashboard += run_text
          # Add update timestamp
          timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
          dashboard += f"\n\n*Last updated: {timestamp}*"

          # Update the README.md file
          repo = g.get_repo("jburel/ome-resources-monitor")
          contents = repo.get_contents("README.md")
          repo.update_file(contents.path, "Update dashboard", dashboard, contents.sha)

          # Create log file
          new_run_file_text += run_text
          new_run_file_text += f"\n\n*Last updated: {timestamp}*"
          repo.create_file('./logs/' + new_run_file, 'Create new log', new_run_file_text)
     
          print("Dashboard updated successfully!")
          EOF

